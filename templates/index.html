<!DOCTYPE html>
<html lang="en" data-theme="{{ theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrack - Your Wellness Journey</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='unified_theme.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: var(--card-bg);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid var(--card-border);
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        .progress-circles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .progress-circle-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .circular-progress {
            position: relative;
            width: 180px;
            height: 180px;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .progress-bg-circle {
            fill: none;
            stroke: var(--progress-bg);
            stroke-width: 12;
        }

        .progress-bar-circle {
            fill: none;
            stroke: var(--primary);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: block;
        }

        .progress-stats h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .favorite-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .favorite-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .favorite-info {
            flex: 1;
            min-width: 200px;
        }

        .favorite-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 5px;
        }

        .favorite-stats {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .favorite-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .favorite-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: var(--primary);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .favorite-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .meal-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .streak-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .streak-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 25px;
            border-radius: 16px;
        }

        .streak-emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .streak-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .streak-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Mode Toggle Button -->
    <div class="mode-toggle" onclick="toggleTheme()">
        <span id="theme-icon">{{ 'üåô' if theme == 'light' else '‚òÄÔ∏è' }}</span>
        <span id="theme-text">{{ 'Dark' if theme == 'light' else 'Light' }}</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>NutriTrack</h1>
            <p>Your personalized wellness journey</p>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <a href="/" class="nav-btn active">
                <i class="fas fa-utensils"></i> Nutrition
            </a>
            <a href="/gym" class="nav-btn">
                <i class="fas fa-dumbbell"></i> Workout
            </a>
            <a href="/settings" class="nav-btn">
                <i class="fas fa-cog"></i> Settings
            </a>
        </div>

        <!-- Progress Section -->
        <div class="totals">
            <h2 style="text-align: center;">Today's Progress</h2>

            <div class="progress-circles">
                <!-- Protein Circle -->
                <div class="progress-circle-wrapper">
                    <div class="circular-progress">
                        <svg width="180" height="180">
                            <circle class="progress-bg-circle" cx="90" cy="90" r="80"></circle>
                            <circle class="progress-bar-circle" cx="90" cy="90" r="80"
                                    stroke-dasharray="502.4"
                                    stroke-dashoffset="{{ 502.4 - (502.4 * protein_percentage / 100) if protein_percentage <= 100 else 0 }}">
                            </circle>
                        </svg>
                        <div class="progress-text">
                            <span class="progress-value">{{ "%.0f"|format(protein_percentage) }}%</span>
                            <span class="progress-label">Protein</span>
                        </div>
                    </div>
                    <div class="progress-stats text-center">
                        <h3>{{ "%.1f"|format(proteinTotal) }}g / {{ protein_goal }}g</h3>
                        <p>Daily Goal</p>
                    </div>
                </div>

                <!-- Calories Circle -->
                <div class="progress-circle-wrapper">
                    <div class="circular-progress">
                        <svg width="180" height="180">
                            <circle class="progress-bg-circle" cx="90" cy="90" r="80"></circle>
                            <circle class="progress-bar-circle" cx="90" cy="90" r="80"
                                    stroke-dasharray="502.4"
                                    stroke-dashoffset="{{ 502.4 - (502.4 * calorie_percentage / 100) if calorie_percentage <= 100 else 0 }}">
                            </circle>
                        </svg>
                        <div class="progress-text">
                            <span class="progress-value">{{ "%.0f"|format(calorie_percentage) }}%</span>
                            <span class="progress-label">Calories</span>
                        </div>
                    </div>
                    <div class="progress-stats text-center">
                        <h3>{{ caloriesTotal|int }} / {{ calorie_goal }}</h3>
                        <p>Daily Goal</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Add Favorites -->
        {% if favorite_foods %}
        <div class="section">
            <h2><i class="fas fa-star"></i> Quick Add Favorites</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Your most logged foods - click to add instantly!</p>

            {% for fav in favorite_foods %}
            <div class="favorite-card">
                <div class="favorite-header">
                    <div class="favorite-info">
                        <div class="favorite-name">{{ fav.food_name }} ({{ fav.quantity }} {{ fav.unit }})</div>
                        <div class="favorite-stats">
                            <i class="fas fa-drumstick-bite"></i> {{ "%.1f"|format(fav.protein) }}g protein  ‚Ä¢
                            <i class="fas fa-fire"></i> {{ fav.calories|int }} cal  ‚Ä¢
                            Logged {{ fav.times_logged }}x
                        </div>
                    </div>
                    <div class="favorite-buttons">
                        <a href="/add_favorite/{{ fav.food_name }}/{{ fav.quantity }}/{{ fav.unit }}/{{ fav.protein }}/{{ fav.calories }}/Breakfast" class="favorite-btn">Breakfast</a>
                        <a href="/add_favorite/{{ fav.food_name }}/{{ fav.quantity }}/{{ fav.unit }}/{{ fav.protein }}/{{ fav.calories }}/Lunch" class="favorite-btn">Lunch</a>
                        <a href="/add_favorite/{{ fav.food_name }}/{{ fav.quantity }}/{{ fav.unit }}/{{ fav.protein }}/{{ fav.calories }}/Dinner" class="favorite-btn">Dinner</a>
                        <a href="/add_favorite/{{ fav.food_name }}/{{ fav.quantity }}/{{ fav.unit }}/{{ fav.protein }}/{{ fav.calories }}/Pre-workout" class="favorite-btn">Snack</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Quick Log from Database -->
        <div class="section">
            <h2><i class="fas fa-book"></i> Quick Log</h2>
            <form action="/add_from_database" method="POST">
                <div class="form-group">
                    <label>Select Food</label>
                    <select name="food" required>
                        <option value="">Choose a food...</option>
                        {% for food_name, food_info in food_database.items() %}
                        <option value="{{ food_name }}">{{ food_name }} - {{ food_info.protein }}g protein</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" step="0.1" name="quantity" placeholder="e.g., 2" required>
                    </div>
                    <div class="form-group">
                        <label>Unit</label>
                        <select name="unit" required>
                            <option value="">Select unit...</option>
                            <option value="grams">Grams (g)</option>
                            <option value="piece">Piece</option>
                            <option value="cup">Cup</option>
                            <option value="tbsp">Tablespoon</option>
                            <option value="tsp">Teaspoon</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Meal Time</label>
                    <select name="meal_time" required>
                        <option value="">When did you eat?</option>
                        <option value="Breakfast">Breakfast</option>
                        <option value="Mid-morning Snack">Mid-morning Snack</option>
                        <option value="Lunch">Lunch</option>
                        <option value="Afternoon Snack">Afternoon Snack</option>
                        <option value="Pre-workout">Pre-workout</option>
                        <option value="Dinner">Dinner</option>
                        <option value="Evening Snack">Evening Snack</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Log Food
                </button>
            </form>
        </div>

        <!-- Custom Food Entry -->
        <div class="section">
            <h2><i class="fas fa-edit"></i> Add Custom Food</h2>
            <form action="/add_custom" method="POST">
                <div class="form-group">
                    <label>Food Name</label>
                    <input type="text" name="food" placeholder="e.g., Homemade Pasta" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" step="0.1" name="quantity" placeholder="1" required>
                    </div>
                    <div class="form-group">
                        <label>Unit</label>
                        <select name="unit" required>
                            <option value="">Select...</option>
                            <option value="plate">Plate</option>
                            <option value="bowl">Bowl</option>
                            <option value="grams">Grams</option>
                            <option value="piece">Piece</option>
                            <option value="cup">Cup</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Protein (g)</label>
                        <input type="number" step="0.1" name="protein" placeholder="25" required>
                    </div>
                    <div class="form-group">
                        <label>Calories</label>
                        <input type="number" step="0.1" name="calories" placeholder="350" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Meal Time</label>
                    <select name="meal_time" required>
                        <option value="">When did you eat?</option>
                        <option value="Breakfast">Breakfast</option>
                        <option value="Mid-morning Snack">Mid-morning Snack</option>
                        <option value="Lunch">Lunch</option>
                        <option value="Afternoon Snack">Afternoon Snack</option>
                        <option value="Pre-workout">Pre-workout</option>
                        <option value="Dinner">Dinner</option>
                        <option value="Evening Snack">Evening Snack</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Add Custom Food
                </button>
            </form>
        </div>

        <!-- Today's Meals -->
        <div class="section">
            <h2><i class="fas fa-history"></i> Today's Meals</h2>

            {% if meals %}
            <div class="meals-container">
                {% for meal in meals %}
                <div class="meal-item">
                    <span class="meal-time" style="display: inline-block; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 10px;">{{ meal.meal_time }}</span>
                    <h3>{{ meal.food }}</h3>
                    <p>
                        <i class="fas fa-drumstick-bite"></i> {{ "%.1f"|format(meal.protein) }}g protein  ‚Ä¢
                        <i class="fas fa-fire"></i> {{ meal.calories|int }} cal
                    </p>
                    <div class="action-buttons">
                        <button class="btn-small btn-edit" onclick="editMeal({{ meal.id }}, '{{ meal.food }}', {{ meal.protein }}, {{ meal.calories }}, '{{ meal.meal_time }}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-small btn-delete" onclick="deleteMeal({{ meal.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <form action="/clear" method="GET" style="margin-top: 25px;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Clear all meals for today?')">
                    <i class="fas fa-trash-alt"></i> Clear All Meals
                </button>
            </form>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-cookie-bite"></i>
                <p>No meals logged yet. Start tracking!</p>
            </div>
            {% endif %}
        </div>

        <!-- Streak Stats -->
        <div class="section">
            <h2 class="text-center"><i class="fas fa-fire"></i> Your Progress</h2>

            <div class="streak-grid">
                <div class="streak-card">
                    <div class="streak-emoji">üî•</div>
                    <div class="streak-number">{{ current_streak }}</div>
                    <div class="streak-label">Day Streak</div>
                </div>
                <div class="streak-card">
                    <div class="streak-emoji">üèÜ</div>
                    <div class="streak-number">{{ best_streak }}</div>
                    <div class="streak-label">Best Streak</div>
                </div>
                <div class="streak-card">
                    <div class="streak-emoji">üìÖ</div>
                    <div class="streak-number">{{ total_days }}</div>
                    <div class="streak-label">Days Tracked</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Meal Modal -->
    <div class="modal" id="editMealModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Meal</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editMealForm" method="POST">
                <input type="hidden" id="edit_meal_id" name="meal_id">
                <div class="form-group">
                    <label>Food Name</label>
                    <input type="text" id="edit_food_name" name="food_name" required>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" step="0.1" id="edit_quantity" name="quantity" required>
                </div>
                <div class="form-group">
                    <label>Protein (g)</label>
                    <input type="number" step="0.1" id="edit_protein" name="protein" required>
                </div>
                <div class="form-group">
                    <label>Calories</label>
                    <input type="number" step="0.1" id="edit_calories" name="calories" required>
                </div>
                <div class="form-group">
                    <label>Meal Time</label>
                    <select id="edit_meal_time" name="meal_time" required>
                        <option value="Breakfast">Breakfast</option>
                        <option value="Mid-morning Snack">Mid-morning Snack</option>
                        <option value="Lunch">Lunch</option>
                        <option value="Afternoon Snack">Afternoon Snack</option>
                        <option value="Pre-workout">Pre-workout</option>
                        <option value="Dinner">Dinner</option>
                        <option value="Evening Snack">Evening Snack</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- Celebration Confetti -->
    {% if goal_reached %}
    <script>
        setTimeout(() => {
            alert('üéâ Amazing! You crushed your goal today! üí™');
        }, 500);
    </script>
    {% endif %}

    <!-- Toast Notification -->
    {% if success_message %}
    <script>
        const messages = {
            'food_logged': '‚úÖ Food logged successfully!',
            'meal_deleted': '‚úÖ Meal deleted successfully!',
            'meal_updated': '‚úÖ Meal updated successfully!',
            'meals_cleared': '‚úÖ All meals cleared!',
            'theme_updated': '‚úÖ Theme updated!',
            'error': '‚ùå An error occurred. Please try again.',
            'error_invalid': '‚ùå Invalid input. Please check your values.',
            'error_empty_food': '‚ùå Food name cannot be empty.',
            'error_quantity': '‚ùå Please enter a valid quantity (0-10000).',
            'error_protein': '‚ùå Please enter valid protein amount (0-1000g).',
            'error_calories': '‚ùå Please enter valid calories (0-10000).'
        };

        const message = messages['{{ success_message }}'] || '‚úÖ Action completed!';
        showToast(message);

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
    {% endif %}

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            html.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('theme-text').textContent = newTheme === 'light' ? 'Dark' : 'Light';

            // Save preference
            fetch('/update_theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'theme=' + newTheme
            });
        }

        function editMeal(id, foodName, protein, calories, mealTime) {
            document.getElementById('edit_meal_id').value = id;
            document.getElementById('edit_food_name').value = foodName;
            // Extract quantity if present in food name (e.g., "Rice (100 grams)")
            document.getElementById('edit_quantity').value = 1;
            document.getElementById('edit_protein').value = protein;
            document.getElementById('edit_calories').value = calories;
            document.getElementById('edit_meal_time').value = mealTime;

            document.getElementById('editMealForm').action = '/edit_meal/' + id;
            document.getElementById('editMealModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editMealModal').classList.remove('active');
        }

        function deleteMeal(id) {
            if (confirm('Are you sure you want to delete this meal?')) {
                window.location.href = '/delete_meal/' + id;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editMealModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
